---
title: å°† Arduino IDE ç§»æ¤åˆ° RISC-V 64
date: 2023-06-09
tags: [arduino, riscv64, java]
published: true
---

import AsciinemaPlayer from "../../../src/components/mdx/asciinema-player.tsx"

åœ¨ [Arch Linux RISC-V](https://archriscv.felixc.at/) å®ä¹ æœŸé—´ï¼Œæˆ‘å°è¯•å°† [ç¬¬ä¸€ä»£ Arduino IDE](https://github.com/arduino/Arduino) ç§»æ¤åˆ° RISC-V 64 ä¸Šã€‚è¿™ç¯‡æ–‡ç« è®°å½•äº†æˆ‘åœ¨ç§»æ¤è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚

é¦–å…ˆï¼Œ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Arch Linux æ€ä¹ˆç»™ Arduino å†™çš„ [`PKGBUILD`](https://gitlab.archlinux.org/archlinux/packaging/packages/arduino/-/blob/8ae0d968593d7f6d7c9bf3189371242c30a9eb66/PKGBUILD) (ä¸‹é¢ä¸ºèŠ‚é€‰):

<CH.Section rows={20}>

å‘¦ï¼Œè¿™ä¹Ÿå¤ªä¸æ¸…çœŸäº†å§ã€‚[æœ‰ä¸¤ä¸ªå…±äº«åº“æ˜¯ç›´æ¥ä»ç½‘ä¸Šæ‹‰ä¸‹æ¥çš„](focus://7:10)ï¼Œå®Œå…¨æ²¡æœ‰ä»æºç ç¼–è¯‘ã€‚ä¸è¿‡[ä»æ³¨é‡Šæ¥çœ‹](focus://24:29,37:40)æ˜¾ç„¶è¿™ä¸ªåŒ…çš„ç»´æŠ¤è€…ä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚

```bash PKGBUILD(part)
source=("${pkgname}-${pkgver}.tar.xz::https://github.com/arduino/Arduino/releases/download/${pkgver}/arduino-${pkgver}.tar.xz"
        "${pkgname}-${pkgver}.tar.xz.asc::https://github.com/arduino/Arduino/releases/download/${pkgver}/arduino-${pkgver}.tar.xz.asc"
        # GPG signatures are not required as zip shasum is already provided by the buildfile
        # https://github.com/arduino/Arduino/issues/11522#issuecomment-840135044
        "https://github.com/arduino-libraries/WiFi101-FirmwareUpdater-Plugin/releases/download/v0.12.0/WiFi101-Updater-ArduinoIDE-Plugin-0.12.0.zip"
        "arduino-examples-1.9.1.zip::https://github.com/arduino/arduino-examples/archive/refs/tags/1.9.1.zip"
        "https://downloads.arduino.cc/libastylej-2.05.1-5.zip"
        "https://downloads.arduino.cc/libastylej-2.05.1-5.zip.asc"
        "https://downloads.arduino.cc/liblistSerials/liblistSerials-1.4.2-2.zip"
        "https://downloads.arduino.cc/liblistSerials/liblistSerials-1.4.2-2.zip.asc"
        "arduino.sh")
package() {
    cd "arduino-${pkgver}/build/linux/work"

    # Create directories
    install -dm755 "${pkgdir}/usr/share/"{doc,icons/hicolor,applications,mime/packages}

    # Copy the whole SDK
    cp -a . "${pkgdir}/usr/share/arduino"

    # Create wrapper for java8 + buider and documentation symlink
    install -Dm755 "${srcdir}/arduino.sh" "${pkgdir}/usr/bin/arduino"

    # Link arduino-builder, libastylej, libserialport and docs
    # TODO astyle libserialport do not work yet
    # TODO remove unzip dependency once all deps are resolved
    # https://github.com/arduino/ctags/issues/12
    # https://github.com/arduino/Arduino/issues/5538
    # https://github.com/arduino/listSerialPortsC/issues/9

    # Arduino-builder
    # https://bugs.archlinux.org/task/52377
    # https://github.com/arduino/arduino-builder/issues/209
    ln -s /usr/bin/arduino-builder "${pkgdir}/usr/share/arduino/arduino-builder"
    install -dm755 "${pkgdir}/usr/share/arduino/tools-builder"

    #rm "${pkgdir}/usr/share/arduino/lib/libastylej.so"
    #ln -s /usr/lib/libastyle-2.05.1.so "${pkgdir}/usr/share/arduino/lib/libastylej.so"
    #rm "${pkgdir}/usr/share/arduino/lib/liblistSerialsj.so"
    #ln -s /usr/lib/libserialport.so "${pkgdir}/usr/share/arduino/lib/liblistSerialsj.so"

    # Install desktop icons (keep a symlink for the arduino binary)
    cp -a lib/icons/* "${pkgdir}/usr/share/icons/hicolor"
    rm -rf "${pkgdir}/usr/share/arduino/lib/icons"
    ln -s /usr/share/icons/hicolor "${pkgdir}/usr/share/arduino/lib/icons"

    # Create desktop file using existing template
    sed "s,<BINARY_LOCATION>,arduino %U,g;s,<ICON_NAME>,arduino,g" "lib/desktop.template" \
    > "${pkgdir}/usr/share/applications/arduino.desktop"

    # Install Arduino mime type
    ln -s /usr/share/arduino/lib/arduino-arduinoide.xml "${pkgdir}/usr/share/mime/packages/arduino.xml"

    # Install manpage
    install -Dm644 "${srcdir}/arduino-${pkgver}/build/shared/arduino.1" "${pkgdir}/usr/share/man/man1/arduino.1"
}
```

</CH.Section>

æ•´ä½“ä¸Šï¼Œæ„Ÿè§‰æŠŠ Arduino IDE ç§»æ¤åˆ° RISC-V 64 åº”è¯¥æ˜¯æŒºç®€å•çš„ï¼Œæ¯•ç«Ÿå®ƒä¸»è¦æ˜¯ç”¨è·¨å¹³å°çš„ Java è¯­è¨€å†™çš„ã€‚

é‚£ä¹ˆï¼Œ æˆ‘ä»¬å†å» Arduino IDE çš„ [GitHub ä»“åº“](https://github.com/arduino/Arduino) çœ‹çœ‹ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆè·Ÿå¹³å°/æ¶æ„ç»‘æ­»çš„ä»£ç ã€‚

è¿™ä¸€çœ‹å¯ä¸å¾—äº†ï¼Œè¿™ä»“åº“æ¯”åˆšæ‰çš„ PKGBUILD è¿˜ä¸æ¸…çœŸï¼Œè¿™ä¸ªä»“åº“é‡Œå­˜äº†ä¸€å¤§å †é¢„å…ˆç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„å‹ç¼©æ–‡ä»¶çš„ checksum,
ç„¶ååœ¨æ„å»ºçš„æ—¶å€™ç›´æ¥ä»ç½‘ä¸Šæ‹‰ä¸‹æ¥ï¼Œè§£å‹ç¼©ã€‚

è¿™é‡Œé¢å¹¶æ²¡æœ‰ç»™ riscv64 çš„é¢„æ„å»ºæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šé€šéœ€è¦è‡ªå·±ç¼–è¯‘ã€‚

![image-20230609115845641](assets/image-20230609115845641.png)

ä¸è¿‡å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€äº›ç»„ä»¶å·²ç»è¢« Arch Linux æ‹†å‡ºæ¥å•ç‹¬æ‰“åŒ…äº†ï¼Œæ¯”å¦‚ [`avr-gcc`](https://archlinux.org/packages/extra/x86_64/avr-gcc/), [`arduino-builder`](https://archlinux.org/packages/extra/x86_64/arduino-builder/), [`arduino-avr-core`](https://archlinux.org/packages/extra/x86_64/arduino-avr-core/) ç­‰ç­‰.

æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è‡ªå·±ç¼–è¯‘ä¸€äº›æ²¡æœ‰è¢«æ‹†å‡ºæ¥çš„ç»„ä»¶å°±å¥½äº†ã€‚

# ç¼–è¯‘ä¸¤ä¸ªå…±äº«åº“

ä»è¡¨é¢ä¸Šæ¥çœ‹ï¼Œåªæœ‰ä¸¤ä¸ªå…±äº«åº“éœ€è¦ç¼–è¯‘ã€‚

## listSerialPortsC

é¦–å…ˆæ˜¯ [`listSerialPortsC`](https://github.com/arduino/listSerialPortsC) è¿™ä¸ªåº“.

æ²¡æœ‰ä»€ä¹ˆéœ€è¦æ”¹çš„ï¼ŒæŠŠ [`compile_linux.sh`](https://github.com/arduino/listSerialPortsC/blob/master/compile_linux.sh) é‡Œçš„å‘½ä»¤ç¨å¾®æ”¹ä¸€æ”¹å°±å¥½äº†ã€‚å› ä¸ºæ˜¯ç›´æ¥åœ¨ riscv64 ä¸Šç¼–è¯‘ï¼Œæ‰€ä»¥ä¸éœ€è¦äº¤å‰ç¼–è¯‘ã€‚

```bash
git clone https://github.com/arduino/listSerialPortsC
cd listSerialPortsC/
git submodule update --init
cd libserialport
./autogen.sh
./configure
make clean
make
cd ..
JAVA_INCLUDE_PATH=/usr/lib/jvm/java-8-openjdk/include
gcc main.c libserialport/linux_termios.c libserialport/linux.c libserialport/serialport.c -Ilibserialport/  -o listSerialC
gcc jnilib.c libserialport/linux_termios.c libserialport/linux.c libserialport/serialport.c -Ilibserialport/ -I$JAVA_INCLUDE_PATH -I$JAVA_INCLUDE_PATH/linux/ -shared -fPIC -o liblistSerialsj.so
```

## astyle

ç„¶åæ˜¯ [`astyle`](https://astyle.sourceforge.net/), è¿™ä¸ªåº“æ˜¯ç”¨æ¥æ ¼å¼åŒ–ä»£ç çš„. Arduino ç»´æŠ¤äº†[ä¸€ä¸ªä»“åº“](https://github.com/arduino/astyle) æ¥å­˜æ”¾ä»–ä»¬çš„æ„å»ºè„šæœ¬å’Œ patches. å¯¹äº riscv64 æ¥è¯´ï¼ŒåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆéœ€è¦æ”¹çš„ã€‚

```bash
git clone https://github.com/arduino/astyle && cd astyle
svn co svn://svn.code.sf.net/p/astyle/code/tags/2.05.1 astyle-code && cd astyle-code
for f in `ls ../patches/*.patch` ; do
	patch -p0 < ../patches/$f
done
cd AStyle/build/gcc/
make clean
JAVA_HOME=/usr/lib/jvm/java-8-openjdk CFLAGS="-Os" LDFLAGS="-s" make java
cp bin/libastyle*.so ../../../../libastylej64.so
```

<AsciinemaPlayer src="./astyle.cast" rows={25} cols={80}/>
[](astyle.cast)

# æ„å»º Arduino IDE

Arduino ä½¿ç”¨äº†ä¸€ä¸ªå¾ˆ old fashion çš„ xml æ–‡ä»¶æ¥æè¿°æ„å»ºè¿‡ç¨‹ï¼Œè¿™ä¸ªæ–‡ä»¶å³ [`build.xml`](https://github.com/arduino/Arduino/blob/master/build/build.xml).

æ„Ÿè§‰è¿™ä¸ªæ–‡ä»¶çš„æŠ½è±¡ç¨‹åº¦ä¸å¤ªå¤Ÿï¼Œå¾ˆå¤šåŒæ ·çš„é€»è¾‘è¢«å†™äº†å¾ˆå¤šéï¼Œä¸è¿‡è¿™ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ–¹ä¾¿äº†æˆ‘ä»¬çš„ä¿®æ”¹ã€‚åªéœ€è¦æŠŠ `linuxaarch64` çš„éƒ¨åˆ†å¤åˆ¶ä¸€ä»½ï¼Œæ”¹æˆ `linuxriscv64`ï¼Œ å†ç¨ä½œä¿®æ”¹å°±å¥½äº†ã€‚

<CH.Section rows={20} lineNumbers={true}>

```diff arduino/arduino-add-riscv64-support.patch
diff --git a/build/build.xml b/build/build.xml
index c4de6aecf..418be1f1e 100644
--- a/build/build.xml
+++ b/build/build.xml
@@ -24,6 +24,7 @@
   <condition property="platform" value="linux64"><os family="unix" arch="amd64" /></condition>
   <condition property="platform" value="linuxarm"><os family="unix" arch="arm" /></condition>
   <condition property="platform" value="linuxaarch64"><os family="unix" arch="aarch64" /></condition>
+  <condition property="platform" value="linuxriscv64"><os family="unix" arch="riscv64" /></condition>

   <condition property="windows_host" value="true"><os family="windows" /></condition>

@@ -35,6 +36,7 @@
   <condition property="linux"><equals arg1="${platform}" arg2="linux64" /></condition>
   <condition property="linux"><equals arg1="${platform}" arg2="linuxarm" /></condition>
   <condition property="linux"><equals arg1="${platform}" arg2="linuxaarch64" /></condition>
+  <condition property="linux"><equals arg1="${platform}" arg2="linuxriscv64" /></condition>

   <condition property="staging_folder" value="macosx"><equals arg1="${platform}" arg2="macosx" /></condition>
   <condition property="staging_folder" value="windows"><equals arg1="${platform}" arg2="windows" /></condition>
@@ -42,6 +44,7 @@
   <condition property="staging_folder" value="linux"><equals arg1="${platform}" arg2="linux64" /></condition>
   <condition property="staging_folder" value="linux"><equals arg1="${platform}" arg2="linuxarm" /></condition>
   <condition property="staging_folder" value="linux"><equals arg1="${platform}" arg2="linuxaarch64" /></condition>
+  <condition property="staging_folder" value="linux"><equals arg1="${platform}" arg2="linuxriscv64" /></condition>

   <condition property="staging_hardware_folder" value="Arduino.app/Contents/Java/hardware"><equals arg1="${platform}" arg2="macosx" /></condition>
   <condition property="staging_hardware_folder" value="hardware"><equals arg1="${platform}" arg2="windows" /></condition>
@@ -49,6 +52,7 @@
   <condition property="staging_hardware_folder" value="hardware"><equals arg1="${platform}" arg2="linux64" /></condition>
   <condition property="staging_hardware_folder" value="hardware"><equals arg1="${platform}" arg2="linuxarm" /></condition>
   <condition property="staging_hardware_folder" value="hardware"><equals arg1="${platform}" arg2="linuxaarch64" /></condition>
+  <condition property="staging_hardware_folder" value="hardware"><equals arg1="${platform}" arg2="linuxriscv64" /></condition>

   <condition property="arch-bits" value="32">
     <equals arg1="${platform}" arg2="linux32"/>
@@ -62,6 +66,9 @@
   <condition property="arch-bits" value="64">
     <equals arg1="${platform}" arg2="linuxaarch64"/>
   </condition>
+  <condition property="arch-bits" value="64">
+    <equals arg1="${platform}" arg2="linuxriscv64"/>
+  </condition>

   <condition property="launch4j-download-unpack-target-name" value="launch4j-windows"><os family="windows" /></condition>
   <property name="launch4j-download-unpack-target-name" value="launch4j-linux"/>
@@ -72,12 +79,14 @@
   <property name="LINUX64_BUNDLED_JVM" value="none"/>
   <property name="LINUXARM_BUNDLED_JVM" value="none"/>
   <property name="LINUXAARCH64_BUNDLED_JVM" value="none"/>
+  <property name="LINUXRISCV64_BUNDLED_JVM" value="none"/>
   <condition property="linux-bundle-jvm-task" value="noop">
     <and>
       <equals arg1="${LINUX32_BUNDLED_JVM}" arg2="none"/>
       <equals arg1="${LINUX64_BUNDLED_JVM}" arg2="none"/>
       <equals arg1="${LINUXARM_BUNDLED_JVM}" arg2="none"/>
       <equals arg1="${LINUXAARCH64_BUNDLED_JVM}" arg2="none"/>
+      <equals arg1="${LINUXRISCV64_BUNDLED_JVM}" arg2="none"/>
     </and>
   </condition>
   <condition property="linux-bundle-jvm-task" value="bundle">
@@ -94,6 +103,9 @@
       <not>
         <equals arg1="${LINUXAARCH64_BUNDLED_JVM}" arg2="none"/>
       </not>
+      <not>
+        <equals arg1="${LINUXRISCV64_BUNDLED_JVM}" arg2="none"/>
+      </not>
     </or>
   </condition>

@@ -776,6 +788,23 @@
     </antcall>
   </target>

+  <target name="linux-libastyle-riscv64" depends="linux-build" description="Copy libastyle.so for Riscv64">
+    <antcall target="portable-${portable}">
+      <param name="parentdir" value="linux/work" />
+    </antcall>
+    <copy file="../../astyle/libastylej.so" tofile="linux/work/lib/libastylej.so" />
+    <chmod perm="755" file="linux/work/lib/libastylej.so" />
+    <copy file="../../listSerialPortsC/liblistSerialsj.so"  todir="linux/work/lib/" />
+    <chmod perm="755" file="linux/work/lib/liblistSerialsj.so" />
+  </target>
+
+  <target name="linuxriscv64-build" depends="linux-libastyle-riscv64" description="Build linux (Riscv64) version">
+    <antcall target="linux-jvm-${linux-bundle-jvm-task}">
+      <param name="JVM" value="${LINUXRISCV64_BUNDLED_JVM}"/>
+    </antcall>
+    <antcall target="build-arduino-builder" />
+  </target>
+
   <target name="linux32-build" depends="linux-libastyle-x86" description="Build linux (32-bit) version">
     <antcall target="linux-jvm-${linux-bundle-jvm-task}">
       <param name="JVM" value="${LINUX32_BUNDLED_JVM}"/>
@@ -832,6 +861,8 @@

   <target name="linuxaarch64-run" depends="build,start"/>

+  <target name="linuxriscv64-run" depends="build,start"/>
+
   <target name="linux32-start">
     <exec executable="./linux/work/arduino" spawn="false" failonerror="true"/>
   </target>
@@ -848,6 +879,10 @@
     <exec executable="./linux/work/arduino" spawn="false" failonerror="true"/>
   </target>

+  <target name="linuxriscv64-start">
+    <exec executable="./linux/work/arduino" spawn="false" failonerror="true"/>
+  </target>
+
   <target name="build-arduino-builder" unless="no_arduino_builder">
     <property name="ARDUINO-BUILDER-EXTRA-VERSION" value="" /> <!-- default if not set already -->
     <delete dir="${staging_folder}/arduino-builder-${platform}" includeemptydirs="true"/>
@@ -979,6 +1014,9 @@
   <target name="linuxaarch64-dist" depends="linux-dist"
 	  description="Build .tar.xz of linux aarch64 version" />

+  <target name="linuxriscv64-dist" depends="linux-dist"
+	  description="Build .tar.xz of linux riscv64 version" />
+
   <!-- - - - - - - - -->
   <!-- Windows       -->
   <!-- - - - - - - - -->
diff --git a/build/build_all_dist.bash b/build/build_all_dist.bash
index 65e67a743..68f98c575 100755
--- a/build/build_all_dist.bash
+++ b/build/build_all_dist.bash
@@ -18,6 +18,9 @@ mv linux/arduino-*-linuxarm.tar.xz ../
 ant -Djava.net.preferIPv4Stack=true -Dplatform=linuxaarch64 $@ clean dist
 mv linux/arduino-*-linuxaarch64.tar.xz ../

+ant -Djava.net.preferIPv4Stack=true -Dplatform=linuxriscv64 $@ clean dist
+mv linux/arduino-*-linuxriscv64.tar.xz ../
+
 ant -Djava.net.preferIPv4Stack=true -Dplatform=windows $@ clean dist
 mv windows/arduino-*-windows.zip ../

```

ä¸»è¦ä¿®æ”¹çš„åœ°æ–¹å°±æ˜¯ [`astyle` å’Œ `listSerialPortsC`](focus://76:84) çš„éƒ¨åˆ†ï¼Œ
è®©æ„å»ºè„šæœ¬å»å¤åˆ¶æˆ‘ä»¬ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶è€Œä¸æ˜¯ä»ç½‘ä¸Šä¸‹è½½è§£å‹å¾—åˆ°çš„æ–‡ä»¶ï¼Œå…¶ä»–çš„å°±æ˜¯å¤åˆ¶ç²˜è´´æŸ¥æ‰¾æ›¿æ¢äº†ã€‚

</CH.Section>

è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ç¬¬ä¸€ç‰ˆ `PKGBUILD`:

<CH.Code rows={20}>

```diff riscv64.patch
--- PKGBUILD
+++ PKGBUILD
@@ -17,7 +17,7 @@ arch=('x86_64')
 url="https://github.com/arduino/Arduino"
 license=('GPL' 'LGPL')
 depends=('gtk3' 'desktop-file-utils' 'shared-mime-info' 'java-runtime=8' 'arduino-builder')
-makedepends=('gtk2-compat' 'java-environment=8' 'ant' 'unzip' 'asciidoc')
+makedepends=('gtk2-compat' 'java-environment=8' 'ant' 'unzip' 'asciidoc' 'git' 'subversion')
 optdepends=('arduino-docs: Offline documentation for arduino'
             'arduino-avr-core: AVR core with upstream avr-gcc and avrdude')
 options=(!strip)
@@ -32,7 +32,12 @@ source=("${pkgname}-${pkgver}.tar.xz::https://github.com/arduino/Arduino/release
         "https://downloads.arduino.cc/libastylej-2.05.1-5.zip.asc"
         "https://downloads.arduino.cc/liblistSerials/liblistSerials-1.4.2-2.zip"
         "https://downloads.arduino.cc/liblistSerials/liblistSerials-1.4.2-2.zip.asc"
-        "arduino.sh")
+        "arduino.sh"
+	"$pkgname-add-riscv64-support.patch"
+	"git+https://github.com/arduino/listSerialPortsC#commit=e4427fa91eb09dcb27541221e134e3333311d32d"
+	"git+https://github.com/arduino/libserialport"
+	"arduino-astyle::git+https://github.com/arduino/astyle#commit=ad8512f5043ae752c1e07b35ef5c5fc0e7bcedb2"
+	"astyle::svn://svn.code.sf.net/p/astyle/code/tags/2.05.1")
 sha512sums=('a7ebc544c3fdc528763dee6f31b923c889aec65139c7ff8bd5309e034cad681d089a5f5fa7fecf3b00e553f812cbfb5ae330344edabdf2cbdaa34425e3ea06ba'
             'SKIP'
             '17e2d07fbdca491a8d80abb6f2ceb000c68af59b755da7db70dce2d5f781204340f43365c40e641acf0b084b2073b3b056f63d68990f405adefb76887f4c5b72'
@@ -41,11 +46,50 @@ sha512sums=('a7ebc544c3fdc528763dee6f31b923c889aec65139c7ff8bd5309e034cad681d089
             'SKIP'
             '5ee4ca9c3137957b4130434cd0ee740fc1747ed1e015a94e5909e2392563c87ad7b60b156aed305510ec5f6cec495b2b478d8e355a9cdef6ca6bfb3ce97badf5'
             'SKIP'
-            '78e2959daeb84828fe3a17b931831cf2581182ef14cc4afacdfba7c305967ebf461bf4098dbae3c07acab5a54d8ee64ba5245c8a75cd2064172bcfbf5dcc243d')
+            '78e2959daeb84828fe3a17b931831cf2581182ef14cc4afacdfba7c305967ebf461bf4098dbae3c07acab5a54d8ee64ba5245c8a75cd2064172bcfbf5dcc243d'
+            'd555d409c9f2338c10cc33ae19cf229a7acdebc91984c7d3fd164b8f7e9e0354a921af2b1d281e14d3936f4e15329123a6e099d16e5b6b3995e3c987301e0d19'
+            'SKIP'
+            'SKIP'
+            'SKIP'
+            'SKIP')
 validpgpkeys=('326567C1C6B288DF32CB061A95FA6F43E21188C4') # Arduino Packages <support@arduino.cc>
 
+prepare() {
+    # liblistSerials
+    cd listSerialPortsC
+    git submodule init
+    git config submodule.libserialport.url "$srcdir/libserialport"
+    git -c protocol.file.allow=always submodule update
+
+    # astyle
+    cd ../astyle
+    for f in `ls ../arduino-astyle/patches/*.patch` ; do
+	patch -p0 < $f
+    done
+
+    # arduino
+    cd "../arduino-${pkgver}"
+    patch -Np1 -i ../$pkgname-add-riscv64-support.patch
+}
+
 build() {
-    cd "arduino-${pkgver}/build"
+    # liblistSerials
+    cd listSerialPortsC/libserialport
+    JAVA_INCLUDE_PATH=/usr/lib/jvm/java-8-openjdk/include
+    ./autogen.sh
+    ./configure --host=riscv64-linux-gnu
+    make
+    cd ..
+    gcc main.c libserialport/linux_termios.c libserialport/linux.c libserialport/serialport.c -Ilibserialport/  -o listSerialC
+    gcc jnilib.c libserialport/linux_termios.c libserialport/linux.c libserialport/serialport.c -Ilibserialport/ -I$JAVA_INCLUDE_PATH -I$JAVA_INCLUDE_PATH/linux/ -shared -fPIC -o liblistSerialsj.so
+
+    # astyle
+    cd ../astyle/AStyle/build/gcc
+    JAVA_HOME=/usr/lib/jvm/java-8-openjdk CFLAGS="-Os" LDFLAGS="-s" make java
+    cp bin/libastyle*.so ../../../libastylej.so
+
+    # arduino
+    cd "../../../../arduino-${pkgver}/build"
 
     # Compile with java8
     export PATH=/usr/lib/jvm/default/bin/:"$PATH"
```

```bash PKGBUILD
# Maintainer: NicoHood <archlinux {cat} nicohood {dog} de>
# PGP ID: 97312D5EB9D7AE7D0BD4307351DAE9B7C1AE9161
# Contributor: Tomas Schertel <tschertel at gmail dot com>
# Contributor: Christopher Loen <christopherloen at gmail dot com>
# Contributor: Peter Reschenhofer <peter.reschenhofer@gmail.com>
# Contributor: Niels MartignÃ¨ne <niels.martignene@gmail.com>
# Contributor: PyroPeter <googlemail.com@abi1789>
# Contributor: darkapex <me@jailuthra.in>
# Contributor: tty0 <vt.tty0[d0t]gmail.com>

pkgname=arduino
pkgver=1.8.19
pkgrel=2
epoch=1
pkgdesc="Arduino prototyping platform SDK"
arch=('x86_64')
url="https://github.com/arduino/Arduino"
license=('GPL' 'LGPL')
depends=('gtk3' 'desktop-file-utils' 'shared-mime-info' 'java-runtime=8' 'arduino-builder')
makedepends=('gtk2-compat' 'java-environment=8' 'ant' 'unzip' 'asciidoc' 'git' 'subversion')
optdepends=('arduino-docs: Offline documentation for arduino'
            'arduino-avr-core: AVR core with upstream avr-gcc and avrdude')
options=(!strip)
install="arduino.install"
source=("${pkgname}-${pkgver}.tar.xz::https://github.com/arduino/Arduino/releases/download/${pkgver}/arduino-${pkgver}.tar.xz"
        "${pkgname}-${pkgver}.tar.xz.asc::https://github.com/arduino/Arduino/releases/download/${pkgver}/arduino-${pkgver}.tar.xz.asc"
        # GPG signatures are not required as zip shasum is already provided by the buildfile
        # https://github.com/arduino/Arduino/issues/11522#issuecomment-840135044
        "https://github.com/arduino-libraries/WiFi101-FirmwareUpdater-Plugin/releases/download/v0.12.0/WiFi101-Updater-ArduinoIDE-Plugin-0.12.0.zip"
        "arduino-examples-1.9.1.zip::https://github.com/arduino/arduino-examples/archive/refs/tags/1.9.1.zip"
        "https://downloads.arduino.cc/libastylej-2.05.1-5.zip"
        "https://downloads.arduino.cc/libastylej-2.05.1-5.zip.asc"
        "https://downloads.arduino.cc/liblistSerials/liblistSerials-1.4.2-2.zip"
        "https://downloads.arduino.cc/liblistSerials/liblistSerials-1.4.2-2.zip.asc"
        "arduino.sh"
	"$pkgname-add-riscv64-support.patch"
	"git+https://github.com/arduino/listSerialPortsC#commit=e4427fa91eb09dcb27541221e134e3333311d32d"
	"git+https://github.com/arduino/libserialport"
	"arduino-astyle::git+https://github.com/arduino/astyle#commit=ad8512f5043ae752c1e07b35ef5c5fc0e7bcedb2"
	"astyle::svn://svn.code.sf.net/p/astyle/code/tags/2.05.1")
sha512sums=('a7ebc544c3fdc528763dee6f31b923c889aec65139c7ff8bd5309e034cad681d089a5f5fa7fecf3b00e553f812cbfb5ae330344edabdf2cbdaa34425e3ea06ba'
            'SKIP'
            '17e2d07fbdca491a8d80abb6f2ceb000c68af59b755da7db70dce2d5f781204340f43365c40e641acf0b084b2073b3b056f63d68990f405adefb76887f4c5b72'
            'c0e21dd374b2751a1e5f2b790202d4883879da2e26e9a23ccbaec478647e2b8160cbc085e76888deafc05b9b14b1aff4ce2a9b834a7b83e8226c3bc41801015c'
            '0678ed29caf8d80aeb852aa8a7f6fe545655314e75eaf6660a2a90505cda39863414ed05cfb8a3323f92d250601c8684021551606c40cea5ed81a1c322a0348c'
            'SKIP'
            '5ee4ca9c3137957b4130434cd0ee740fc1747ed1e015a94e5909e2392563c87ad7b60b156aed305510ec5f6cec495b2b478d8e355a9cdef6ca6bfb3ce97badf5'
            'SKIP'
            '78e2959daeb84828fe3a17b931831cf2581182ef14cc4afacdfba7c305967ebf461bf4098dbae3c07acab5a54d8ee64ba5245c8a75cd2064172bcfbf5dcc243d'
            'd555d409c9f2338c10cc33ae19cf229a7acdebc91984c7d3fd164b8f7e9e0354a921af2b1d281e14d3936f4e15329123a6e099d16e5b6b3995e3c987301e0d19'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP')
validpgpkeys=('326567C1C6B288DF32CB061A95FA6F43E21188C4') # Arduino Packages <support@arduino.cc>

prepare() {
    # liblistSerials
    cd listSerialPortsC
    git submodule init
    git config submodule.libserialport.url "$srcdir/libserialport"
    git -c protocol.file.allow=always submodule update

    # astyle
    cd ../astyle
    for f in `ls ../arduino-astyle/patches/*.patch` ; do
	patch -p0 < $f
    done

    # arduino
    cd "../arduino-${pkgver}"
    patch -Np1 -i ../$pkgname-add-riscv64-support.patch
}

build() {
    # liblistSerials
    cd listSerialPortsC/libserialport
    JAVA_INCLUDE_PATH=/usr/lib/jvm/java-8-openjdk/include
    ./autogen.sh
    ./configure --host=riscv64-linux-gnu
    make
    cd ..
    gcc main.c libserialport/linux_termios.c libserialport/linux.c libserialport/serialport.c -Ilibserialport/  -o listSerialC
    gcc jnilib.c libserialport/linux_termios.c libserialport/linux.c libserialport/serialport.c -Ilibserialport/ -I$JAVA_INCLUDE_PATH -I$JAVA_INCLUDE_PATH/linux/ -shared -fPIC -o liblistSerialsj.so

    # astyle
    cd ../astyle/AStyle/build/gcc
    JAVA_HOME=/usr/lib/jvm/java-8-openjdk CFLAGS="-Os" LDFLAGS="-s" make java
    cp bin/libastyle*.so ../../../libastylej.so

    # arduino
    cd "../../../../arduino-${pkgver}/build"

    # Compile with java8
    export PATH=/usr/lib/jvm/default/bin/:"$PATH"

    # Do not include their avr-core + tools and no docs. We build them seperately
    ant clean dist -Dversion="${pkgver}" build -Dlight_bundle=true \
                                             -Dno_docs=true \
                                             -Dlocal_sources=true \
                                             -Dno_arduino_builder=true

    # Build man page
    a2x -f manpage shared/manpage.adoc
}

package() {
    cd "arduino-${pkgver}/build/linux/work"

    # Create directories
    install -dm755 "${pkgdir}/usr/share/"{doc,icons/hicolor,applications,mime/packages}

    # Copy the whole SDK
    cp -a . "${pkgdir}/usr/share/arduino"

    # Create wrapper for java8 + buider and documentation symlink
    install -Dm755 "${srcdir}/arduino.sh" "${pkgdir}/usr/bin/arduino"

    # Link arduino-builder, libastylej, libserialport and docs
    # TODO astyle libserialport do not work yet
    # TODO remove unzip dependency once all deps are resolved
    # https://github.com/arduino/ctags/issues/12
    # https://github.com/arduino/Arduino/issues/5538
    # https://github.com/arduino/listSerialPortsC/issues/9

    # Arduino-builder
    # https://bugs.archlinux.org/task/52377
    # https://github.com/arduino/arduino-builder/issues/209
    ln -s /usr/bin/arduino-builder "${pkgdir}/usr/share/arduino/arduino-builder"
    install -dm755 "${pkgdir}/usr/share/arduino/tools-builder"

    #rm "${pkgdir}/usr/share/arduino/lib/libastylej.so"
    #ln -s /usr/lib/libastyle-2.05.1.so "${pkgdir}/usr/share/arduino/lib/libastylej.so"
    #rm "${pkgdir}/usr/share/arduino/lib/liblistSerialsj.so"
    #ln -s /usr/lib/libserialport.so "${pkgdir}/usr/share/arduino/lib/liblistSerialsj.so"

    # Install desktop icons (keep a symlink for the arduino binary)
    cp -a lib/icons/* "${pkgdir}/usr/share/icons/hicolor"
    rm -rf "${pkgdir}/usr/share/arduino/lib/icons"
    ln -s /usr/share/icons/hicolor "${pkgdir}/usr/share/arduino/lib/icons"

    # Create desktop file using existing template
    sed "s,<BINARY_LOCATION>,arduino %U,g;s,<ICON_NAME>,arduino,g" "lib/desktop.template" \
    > "${pkgdir}/usr/share/applications/arduino.desktop"

    # Install Arduino mime type
    ln -s /usr/share/arduino/lib/arduino-arduinoide.xml "${pkgdir}/usr/share/mime/packages/arduino.xml"

    # Install manpage
    install -Dm644 "${srcdir}/arduino-${pkgver}/build/shared/arduino.1" "${pkgdir}/usr/share/man/man1/arduino.1"
}
```

</CH.Code>


# è°ƒè¯•

<CH.Section>

ç„¶åå¯åŠ¨ qemu-user æµ‹è¯•äº†ä¸€ä¸‹ï¼Œå‘ç° Arduino IDE èƒ½é¡ºåˆ©çš„è·‘èµ·æ¥.

:::tip

è¿™é‡Œä½¿ç”¨çš„ archriscv qemu-user å®¹å™¨å¯ä»¥å‚è€ƒ[è¿™ä¸ªæ•™ç¨‹](https://github.com/felixonmars/archriscv-packages/wiki/Setup-Arch-Linux-RISC-V-Development-Environment)æ­å»ºï¼Œæ³¨æ„éœ€è¦ä¿®æ”¹ _`start-user`_ è„šæœ¬æ¥

1. [æŒ‚è½½ä¸²å£è®¾å¤‡ _`/dev/ttyACM0`_ (è®¾å¤‡åè§†æƒ…å†µè€Œå®š)](focus://start-user#4)
2. [å…±äº« _`/run/user/1000`_ ç›®å½•](focus://start-user#3) (å¯èƒ½ä¸æ˜¯å¿…é¡»çš„)
3. [å…±äº« X11 unix socket _`/tmp/.X11-unix`_ ç›®å½•](focus://start-user#5)

:::


<CH.Code>

```bash commands-to-run
xhost +local:
sudo ./start-user
```

---

```bash start-user
systemd-nspawn -a -D ./archriscv \
    --bind=/home/kxxt/Workspaces/arch-riscv:/home/kxxt/archriscv \
    --bind=/run/user/1000 \
    --bind=/dev/ttyACM0 \
    --bind-ro=/tmp/.X11-unix \
    --capability=CAP_SYS_ADMIN
```

</CH.Code>

</CH.Section>

![](./assets/arduino.png)

ä½†æ˜¯ä¸²å£ç›‘è§†å™¨ä¸å·¥ä½œã€‚

![](./assets/jssc-err.jpg)

[Google æœç´¢ç»“æœ](https://www.google.com/search?client=firefox-b-d&q=java.lang.UnsatisfiedLinkError%3A+jssc.SerialNativeInterface.openPort%28Ljava%2Flang%2FString%3BZ%29J)
æ˜¾ç¤ºç¡®å®æœ‰ Arduino ç”¨æˆ·é‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æœå‡ºæ¥çš„è§£å†³æ–¹æ¡ˆå¹¶ä¸é€‚ç”¨äºæˆ‘ä»¬çš„æƒ…å†µã€‚

åªå¥½å»çœ‹ [jssc çš„æºç ](https://github.com/java-native/jssc/tree/v2.8.0)äº†. ä¸€çœ‹ï¼Œå§æ§½ï¼Œç«Ÿç„¶è¿˜æœ‰è¿™ç§æ“ä½œï¼

> This version contains native libs for Windows(x86, x86-64), Linux(x86, x86-64, ARM soft & hard float), Solaris(x86, x86-64), Mac OS X(x86, x86-64, PPC, PPC64).
All native libs contains in the jssc.jar file and you don't need manage native libs manually.

![](./assets/jssc-libs.png)

jSSC æŠŠå„ç§å¹³å°çš„ native åº“éƒ½æ‰“åŒ…åˆ°äº† jar é‡Œé¢å»ï¼Œ è‡ªç„¶é‡Œé¢æ²¡æœ‰é€‚ç”¨äº riscv64 çš„ã€‚

è¿™ä¸¥é‡çš„ç ´åäº† [jar æ–‡ä»¶æ ¼å¼çš„å¹³å°æ— å…³æ€§ (platform-independent)](https://docs.oracle.com/javase/8/docs/technotes/guides/jar/index.html).
kxxt åœ¨æ­¤å¼ºçƒˆè°´è´£è¿™ç§è¡Œä¸ºï¼ï¼ ğŸ‘¿ğŸ˜¡ğŸ˜¤

# è§£å†³

é‚£ä¹ˆåº”è¯¥æŠŠ riscv64 çš„ native åº“ä¹Ÿæ‰“åŒ…åˆ° jar é‡Œé¢å»å°±èƒ½è§£å†³é—®é¢˜äº†ã€‚

jSSC 2.8.0 çš„ä»“åº“é‡Œå°±åªæœ‰å…‰ç§ƒç§ƒçš„æºç å’Œé¢„ç¼–è¯‘å¥½çš„ native libs, ä¹Ÿæ²¡æœ‰ `Makefile`, ä¹Ÿæ²¡æœ‰ `CMakeLists.txt` ä¹‹ç±»çš„æ„å»ºè„šæœ¬ï¼Œ `README` å’Œ Wiki é‡Œä¹Ÿæ²¡æœ‰æ„å»ºçš„å‘½ä»¤ã€‚

åªå¥½è‡ªå·±å»çŒœä¸€çŒœè¯•ä¸€è¯•äº†:

<CH.Section>

```bash
git clone https://github.com/java-native/jssc -b v2.8.0 && cd jssc
mkdir build
cp -r src/java/libs build
JAVA_INCLUDE_PATH=/usr/lib/jvm/java-8-openjdk/include
g++ src/cpp/_nix_based/jssc.cpp -I$JAVA_INCLUDE_PATH -I$JAVA_INCLUDE_PATH/linux/ \
    -shared -fPIC -o build/libs/linux/libjSSC-2.8_riscv64.so -static-libstdc++ -static-libgcc
find src/java/jssc -type f -name '*.java' | xargs javac -d build
jar cf jssc-2.8.0-arduino4.jar -C build .
```

ä½¿ç”¨æˆ‘ä»¬è‡ªå·±ç¼–è¯‘å‡ºæ¥çš„ _`jssc-2.8.0-arduino4.jar`_ æ›¿æ¢æ‰ `/usr/share/arduino/lib/jssc-2.8.0-arduino4.jar` ä¹‹åï¼Œ
å†æ¬¡å¯åŠ¨ Arduino IDEï¼Œæ‰“å¼€ä¸²å£ç›‘è§†å™¨ï¼Œå®ƒå°± work è¾£ï¼

</CH.Section>

![](./assets/serial.png)

# ç»“å°¾

å› ä¸º Arduino å’Œ ESP32 çš„ board registry é‡Œé¢å¹¶æ²¡æœ‰ riscv64 çš„å·¥å…·é“¾ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½å»ä½¿ç”¨åŒ…ä»“åº“é‡Œçš„ `arduino-avr-core` äº†ã€‚

ç„¶è€Œæˆ‘æ‰‹å¤´å¹¶æ²¡æœ‰ AVR çš„æ¿å­ï¼Œåªæœ‰ä¸¤ä¸ª ESP32 æ¿å­ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰åŠæ³•å»æŠŠç¼–è¯‘å‡ºæ¥çš„ç¨‹åºçƒ§å½•åˆ°æ¿å­ä¸Šå»æµ‹è¯•ã€‚

å¦å¤–æˆ‘ä»¬ä»“åº“é‡Œçš„ `avr-gcc` è¿˜æœ‰ä¸ªå°é—®é¢˜æœ‰å¾…è§£å†³ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆå®ƒåœ¨ riscv64 ä¸Šä¼šä¸æ”¯æŒ `-fno-fat-lto-objects` é€‰é¡¹ï¼Œ
è€Œ Arduino åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šç”¨åˆ°è¿™ä¸ªé€‰é¡¹ã€‚

![](./assets/err.png)
